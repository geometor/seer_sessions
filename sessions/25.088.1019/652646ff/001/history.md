
## train_1

**input:**
```
2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2
2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2
2 2 2 5 2 2 2 2 2 2 2 2 2 2 2 2 2 5 2 2
2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2
2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2
2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2
2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2
2 2 2 4 4 2 2 2 8 8 2 2 2 2 2 2 2 2 2 2
2 2 4 2 2 4 2 8 2 2 8 2 3 3 2 2 2 2 2 2
2 4 2 2 2 2 4 5 2 2 2 8 2 2 3 2 2 2 2 2
2 4 2 9 2 2 4 2 2 2 3 8 2 9 2 3 2 2 2 2
2 2 4 2 2 4 2 8 2 2 8 2 2 2 2 3 2 2 2 2
2 2 2 4 4 2 2 2 8 8 2 3 2 2 3 2 2 2 2 2
2 2 2 2 2 2 2 2 2 2 2 2 3 3 2 2 2 2 2 2
2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2
2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2
2 2 2 2 2 2 2 2 2 2 5 2 2 2 2 2 2 2 2 2
2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2
2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2
5 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2
```


**output:**
```
2 2 4 4 2 2
2 4 2 2 4 2
4 2 2 2 2 4
4 2 2 2 2 4
2 4 2 2 4 2
2 2 4 4 2 2
2 2 8 8 2 2
2 8 2 2 8 2
8 2 2 2 2 8
8 2 2 2 2 8
2 8 2 2 8 2
2 2 8 8 2 2
2 2 3 3 2 2
2 3 2 2 3 2
3 2 2 2 2 3
3 2 2 2 2 3
2 3 2 2 3 2
2 2 3 3 2 2
```


## train_2

**input:**
```
3 3 3 3 3 3 3 3 3 3
5 3 3 4 4 3 3 3 3 3
3 3 4 3 8 4 3 3 3 3
3 4 3 8 3 3 4 3 3 3
3 4 8 1 3 3 4 8 3 3
3 1 4 3 1 4 3 8 3 3
1 3 3 4 4 1 8 3 3 3
1 3 5 3 8 8 3 3 3 3
3 1 3 3 1 3 3 3 3 3
3 3 1 1 3 3 5 3 3 3
```


**output:**
```
3 3 4 4 3 3
3 4 3 3 4 3
4 3 3 3 3 4
4 3 3 3 3 4
3 4 3 3 4 3
3 3 4 4 3 3
3 3 8 8 3 3
3 8 3 3 8 3
8 3 3 3 3 8
8 3 3 3 3 8
3 8 3 3 8 3
3 3 8 8 3 3
3 3 1 1 3 3
3 1 3 3 1 3
1 3 3 3 3 1
1 3 3 3 3 1
3 1 3 3 1 3
3 3 1 1 3 3
```


## train_3

**input:**
```
4 4 4 4 4 5 4 4 4 4 4 4 4
4 4 4 4 4 4 4 4 4 4 4 7 4
4 4 2 2 4 4 4 4 4 4 4 4 4
4 2 4 4 2 4 4 4 4 4 4 4 4
2 4 4 7 4 2 4 4 4 4 4 4 4
2 4 4 4 4 8 8 4 4 5 4 4 4
4 2 4 4 8 4 4 8 4 4 4 4 4
4 4 2 8 4 4 4 4 8 4 4 4 4
4 4 4 8 4 4 4 4 3 3 4 4 4
4 4 4 4 8 4 4 3 4 4 3 4 4
4 5 4 4 4 8 3 4 4 4 4 3 4
4 4 7 4 4 4 3 4 4 5 4 3 4
4 4 4 4 4 4 4 3 4 4 3 4 4
```


**output:**
```
4 4 3 3 4 4
4 3 4 4 3 4
3 4 4 4 4 3
3 4 4 4 4 3
4 3 4 4 3 4
4 4 3 3 4 4
4 4 8 8 4 4
4 8 4 4 8 4
8 4 4 4 4 8
8 4 4 4 4 8
4 8 4 4 8 4
4 4 8 8 4 4
4 4 2 2 4 4
4 2 4 4 2 4
2 4 4 4 4 2
2 4 4 4 4 2
4 2 4 4 2 4
4 4 2 2 4 4
```


## train_4

**input:**
```
8 8 8 8 8 8 8 8 5 8
8 8 8 8 8 8 8 8 8 8
8 8 8 4 4 8 3 3 8 8
8 8 4 8 8 4 8 8 3 8
8 4 2 8 3 8 4 8 8 3
8 4 8 8 3 8 4 8 8 3
8 8 4 8 8 4 8 8 3 8
8 8 8 4 4 8 3 3 8 8
8 5 8 8 8 8 8 8 8 8
8 8 8 8 8 8 8 2 8 8
```


**output:**
```
8 8 4 4 8 8
8 4 8 8 4 8
4 8 8 8 8 4
4 8 8 8 8 4
8 4 8 8 4 8
8 8 4 4 8 8
8 8 3 3 8 8
8 3 8 8 3 8
3 8 8 8 8 3
3 8 8 8 8 3
8 3 8 8 3 8
8 8 3 3 8 8
```

**Perception of the Elements:**

1.  **Input Grid:** Contains a dominant background color, several distinct geometric shapes (objects) made of other colors, and sometimes isolated pixels of Gray (5), Orange (7), or Maroon (9).
2.  **Output Grid:** Consists of a vertical stack of the shapes extracted from the input. The background color within the bounding box of each shape in the output matches the input's background color.
3.  **Objects:** Objects are contiguous blocks of pixels of the same color, distinct from the background.
4.  **Relevant Colors:** Colors used for shapes that appear in the output are Blue(1), Red(2), Green(3), Yellow(4), and Azure(8).
5.  **Ignored Colors:** The background color, Gray(5), Orange(7), and Maroon(9) are always ignored. Red(2) is ignored specifically when the background color is Azure(8).
6.  **Transformation:** The core transformation involves identifying relevant shapes, determining their bounding boxes, sorting these shapes according to specific rules, and then stacking their bounding boxes vertically to form the output.
7.  **Sorting:** Shapes are primarily sorted based on their position in the input grid, specifically by the row index of their top-most pixel, with the column index of the left-most pixel used as a tie-breaker (top-left rule).
8.  **Sorting Exception:** If the background color of the input grid is Yellow(4), the sorting order determined by the top-left rule is reversed.
9.  **Output Construction:** The final output grid's width is the maximum width of the bounding boxes of the selected shapes. Its height is the sum of the heights of these bounding boxes. Each shape's bounding box is placed sequentially in the vertical stack. Within each bounding box, the original shape's pixels are preserved, and all other pixels are filled with the input grid's background color.

**Facts (YAML):**


```yaml
task_description: Extract specific colored shapes from an input grid, sort them based on position (with a conditional reversal), and stack their bounding boxes vertically in the output grid.

elements:
  - type: grid
    properties:
      - background_color: The most frequent color in the input grid.
      - objects: Contiguous blocks of pixels with uniform color, different from the background.
      - ignored_colors: [Gray(5), Orange(7), Maroon(9)]
      - conditionally_ignored_color: Red(2) is ignored if background_color is Azure(8).
      - relevant_colors: Colors of objects that are not ignored.

actions:
  - action: identify_background
    input: input_grid
    output: background_color
  - action: find_objects
    input: input_grid, background_color
    output: list_of_all_objects (color, pixels, bounding_box, top_left_coord)
  - action: filter_objects
    input: list_of_all_objects, background_color
    output: list_of_relevant_objects
    criteria:
      - object_color is not in [Gray(5), Orange(7), Maroon(9)]
      - if background_color is Azure(8), object_color is not Red(2)
  - action: sort_objects
    input: list_of_relevant_objects
    output: sorted_list_of_objects
    criteria:
      - primary_key: top_left_coord.row
      - secondary_key: top_left_coord.col
  - action: conditional_reverse
    input: sorted_list_of_objects, background_color
    output: final_ordered_list_of_objects
    condition: if background_color is Yellow(4), reverse the sorted_list_of_objects.
  - action: construct_output
    input: final_ordered_list_of_objects, background_color
    output: output_grid
    process: Vertically stack the bounding boxes. For each bounding box, fill with background_color and overlay the object's pixels.

relationships:
  - The sorting order depends on the object's top-left position.
  - The final sorting order depends on the background color (Yellow(4) triggers reversal).
  - Object relevance depends on its color and potentially the background color (Red(2) vs Azure(8) background).
  - Output grid dimensions depend on the dimensions of the relevant objects' bounding boxes.
```


**Natural Language Program:**

1.  Determine the background color by finding the most frequent pixel color in the input grid.
2.  Identify all contiguous objects (shapes) in the input grid that are composed of a single color different from the background color.
3.  Filter these objects: Keep only the objects whose color is NOT Gray (5), Orange (7), or Maroon (9). Furthermore, if the background color is Azure (8), also discard any objects whose color is Red (2).
4.  For each remaining relevant object, calculate its minimal bounding box and identify its top-left corner coordinates (minimum row, minimum column).
5.  Sort these relevant objects based on their top-left coordinates, ordering primarily by row index (ascending) and secondarily by column index (ascending).
6.  Examine the background color identified in step 1. If the background color is Yellow (4), reverse the order of the sorted list of objects.
7.  Determine the dimensions for the output grid: the width should be the maximum width among all bounding boxes of the finally ordered objects, and the height should be the sum of all their heights.
8.  Create the output grid with these dimensions.
9.  Iterate through the objects in their final sorted (and potentially reversed) order. For each object:
    a. Create a temporary grid matching the object's bounding box dimensions.
    b. Fill this temporary grid entirely with the background color.
    c. Place the actual pixels of the object onto this temporary grid at their relative positions within the bounding box.
    d. Append this temporary grid to the bottom of the output grid being constructed.
10. The fully constructed grid is the final output.
